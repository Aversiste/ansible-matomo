image: debian/stretch
packages:
  - mysql-server
  - python-mysqldb
  - python-openssl
  - python3-pip
  - tar
sources:
  - https://github.com/Aversiste/ansible-matomo
tasks:
  - packages: |
      # Please Debian, stop trying to be smart and don't install apache2
      sudo apt-get -qq install --no-install-recommends nginx php php-cli \
          php-curl php-fpm php-gd php-mbstring php-mysql php-xml
  - pip: |
      sudo pip3 -q install ansible
  - setup: |
      echo "Creating roles/ directory"
      mkdir roles
      mv ansible-matomo roles/
      echo "Creating ansible.cfg"
      cat <<EOD > ansible.cfg
      [defaults]
      stdout_callback = yaml
      roles_path = roles
      EOD
      echo "Creating inventory"
      cat <<EOD > inventory
      [all]
      localhost
      EOD
      echo "Creating playbook.yml"
      cat <<EOD > playbook.yml
      ---
      - hosts: all
        connection: local
        roles:
          - role: ansible-matomo
      EOD
      echo "Creating group_vars/ directory"
      mkdir group_vars
      cat <<EOD > group_vars/all.yml
      ---
      matomo_mysql_database: matomodata
      matomo_mysql_user: matomo
      matomo_mysql_password: matomo
      matomo_superuser_user: admin
      matomo_superuser_password: adminadmin42
      matomo_version: "3.9.0"
      matomo_name: localhost
      EOD
  - run: |
      /usr/local/bin/ansible-playbook -b -i inventory playbook.yml
